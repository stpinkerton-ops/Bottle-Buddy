<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Bottle Buddy</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        :root {
            --bg-primary: #F2F2F7; --bg-secondary: #FFFFFF; --bg-tertiary: #E9E9EB;
            --text-primary: #1D1D1F; --text-secondary: #6E6E73; --accent-color: #007AFF;
            --separator-color: #E5E5EA; --danger-color: #FF3B30;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #000000; --bg-secondary: #1C1C1E; --bg-tertiary: #2C2C2E;
                --text-primary: #F5F5F7; --text-secondary: #8E8E93; --accent-color: #0A84FF;
                --separator-color: #38383A; --danger-color: #FF453A;
            }
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { -webkit-font-smoothing: antialiased; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Helvetica Neue", sans-serif; background-color: var(--bg-primary); color: var(--text-primary); padding-bottom: 90px; }
        .container { max-width: 600px; margin: 0 auto; padding: 16px; }
        .header { display: flex; align-items: center; gap: 12px; padding: 20px 0; }
        .header img { width: 40px; height: 40px; border-radius: 8px; }
        .header h1 { font-size: 28px; font-weight: 700; margin: 0; }
        .header p { font-size: 16px; color: var(--text-secondary); margin: 2px 0 0 0; }
        h2 { font-size: 22px; font-weight: 700; margin-bottom: 16px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; height: calc(50px + env(safe-area-inset-bottom)); background-color: var(--bg-secondary); border-top: 0.5px solid var(--separator-color); display: flex; justify-content: space-around; padding-bottom: env(safe-area-inset-bottom); z-index: 1000; }
        .tab-button { background: none; border: none; color: var(--text-secondary); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; font-size: 10px; cursor: pointer; flex-grow: 1; }
        .tab-button.active { color: var(--accent-color); }
        .tab-button svg { width: 24px; height: 24px; }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
        .card { background-color: var(--bg-secondary); border-radius: 12px; padding: 16px; }
        .card-title { font-size: 14px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px; }
        .card-value { font-size: 28px; font-weight: 600; color: var(--text-primary); }
        .tracker-summary-item { display: flex; justify-content: space-between; align-items: center; font-size: 16px; padding: 4px 0;}
        .btn { display: block; width: 100%; font-size: 17px; font-weight: 600; padding: 14px; border-radius: 12px; border: none; cursor: pointer; background-color: var(--accent-color); color: white; margin-top: 16px; }
        .btn-secondary { background-color: var(--bg-tertiary); color: var(--accent-color); }
        .breast-toggle { display: flex; background-color: var(--bg-tertiary); border-radius: 8px; padding: 4px; margin-top: 16px; }
        .breast-toggle button { flex: 1; padding: 8px; border: none; background-color: transparent; color: var(--text-primary); font-size: 14px; font-weight: 600; border-radius: 6px; cursor: pointer; }
        .breast-toggle button.selected { background-color: var(--bg-secondary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stopwatch-time { font-size: 64px; font-weight: 300; text-align: center; margin: 20px 0; font-family: monospace; }
        .timer-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
        .amount-input { display: flex; align-items: center; gap: 10px; margin-top: 16px; }
        .amount-input input, .amount-input select { border-radius: 8px; background-color: var(--bg-tertiary); border: none; padding: 12px; font-size: 16px; color: var(--text-primary); }
        .amount-input input { flex-grow: 1; }
        .diaper-counters { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .diaper-btn { background-color: var(--bg-secondary); border-radius: 12px; padding: 24px; text-align: center; border: none; cursor: pointer; }
        .diaper-btn .emoji { font-size: 48px; }
        .diaper-btn .label { font-size: 16px; color: var(--text-primary); margin-top: 8px; }
        .severity-selector { display: none; margin-top: 16px; background-color: var(--bg-secondary); border-radius: 12px; padding: 16px; }
        .severity-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .severity-buttons button { background-color: var(--bg-tertiary); color: var(--text-primary); border: none; padding: 12px; border-radius: 8px; font-size: 16px; cursor: pointer;}
        .log-list { margin-top: 24px; }
        .log-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 0.5px solid var(--separator-color); }
        .log-item:first-child { border-top: 0.5px solid var(--separator-color); }
        .log-details { font-size: 16px; }
        .log-time { font-size: 14px; color: var(--text-secondary); text-align: right; }
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; padding-right: 20px; background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%238E8E93' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 8px center; background-size: 0.8em; }
        .form-section { background-color: var(--bg-secondary); border-radius: 12px; padding: 0 20px; margin-bottom: 24px; }
        .form-row { display: grid; grid-template-columns: 1fr 2fr; align-items: center; gap: 16px; min-height: 48px; border-bottom: 0.5px solid var(--separator-color); }
        .form-row:last-child { border-bottom: none; }
        .form-row label, .form-row .form-label { font-size: 16px; font-weight: 400; color: var(--text-primary); }
        .form-row input, .form-row select { width: 100%; background: none; border: none; color: var(--text-primary); font-size: 16px; text-align: right; outline: none; }
        .form-row input[type="text"] { text-align: left; padding: 10px 0; }
        .form-row input::placeholder { color: var(--text-secondary); }
        .toggle-switch { position: relative; display: inline-block; width: 51px; height: 31px; justify-self: end; }
        .toggle-switch input { display: none; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-tertiary); transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #34C759; }
        input:checked + .slider:before { transform: translateX(20px); }
        .tracker-item { background-color: var(--bg-secondary); border-radius: 12px; margin-bottom: 16px; padding: 16px; }
        .tracker-item h4 { font-size: 18px; font-weight: 600; margin-bottom: 5px; }
        .tracker-item .tracker-date { font-size: 14px; color: var(--text-secondary); margin-bottom: 15px; }
        .reminder-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .reminder-time-input { background-color: var(--bg-tertiary); border: none; border-radius: 6px; padding: 6px 10px; font-size: 15px; color: var(--text-primary); text-align: center; }
        .action-buttons { display: flex; gap: 16px; margin-top: 16px; justify-content: flex-end; align-items: center; }
        .btn-small { padding: 6px 12px; font-size: 14px; border-radius: 8px; background-color: var(--bg-tertiary); color: var(--text-primary); border: none; cursor: pointer; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .notify-toggle-group { display: flex; align-items: center; gap: 8px; font-size: 14px; }
        .notify-toggle-group .toggle-switch { transform: scale(0.75); }
        .empty-state { text-align: center; padding: 40px; color: var(--text-secondary); }
        @media (max-width: 600px) {
            .form-row { display: block; padding: 12px 0; }
            .form-row label, .form-row .form-label { display: block; margin-bottom: 8px; font-weight: 500;}
            .form-row input, .form-row select { text-align: left; background-color: var(--bg-tertiary); padding: 12px; border-radius: 8px; }
            .toggle-switch { justify-self: start; }
        }
    </style>
</head>
<body>

    <div id="homescreen-content" class="tab-content active">
        <div class="container"><div class="header"><img src="icon.png" alt="Bottle Buddy Icon"><div><h1>Bottle Buddy</h1><p>Track your feeds with ease</p></div></div><div id="summary-section"></div></div>
    </div>

    <div id="feeding-content" class="tab-content">
        <div class="container">
            <h2>Log a Feed</h2>
            <div class="card">
                <div class="stopwatch-time" id="stopwatchDisplay">00:00:00</div>
                <div class="timer-controls"><button class="btn" id="startStopBtn">Start</button><button class="btn btn-secondary" id="resetBtn">Reset</button></div>
                <div class="amount-input"><input type="number" id="bottleAmount" placeholder="Amount"><select id="bottleUnit"><option>oz</option><option>ml</option></select></div>
                <div class="card-title" style="margin-top: 20px;">Breast (Optional)</div>
                <div class="breast-toggle"><button id="breast-left" onclick="selectBreast('left')">Left</button><button id="breast-right" onclick="selectBreast('right')">Right</button></div>
            </div>
            <button class="btn" id="logFeedBtn">Log Feed</button>
            <div class="log-list" id="feedingLog"></div>
        </div>
    </div>

    <div id="tracker-content" class="tab-content">
         <div class="container">
            <h2>Schedule Events</h2>
             <div class="form-section">
                <div class="form-row"><label for="trackerName">Event</label><input type="text" id="trackerName" placeholder="Event Name"></div>
                <div class="form-row"><label for="trackerDate">Date</label><input type="date" id="trackerDate"></div>
                <div class="form-row"><label for="firstEventTime">Start Time</label><input type="time" id="firstEventTime"></div>
                <div class="form-row"><label for="endTime">End Time</label><input type="time" id="endTime"></div>
                <div class="form-row"><label for="intervalAmount">Interval</label><input type="number" id="intervalAmount" min="1" value="2"></div>
                <div class="form-row"><label for="intervalUnit">Interval Unit</label><select id="intervalUnit"><option value="hours">Hours</option><option value="minutes">Minutes</option></select></div>
                <div class="form-row"><label for="alertBefore">Calendar Alert</label><input type="number" id="alertBefore" min="0" value="5"></div>
                <div class="form-row"><label for="alertUnit">Alert Unit</label><select id="alertUnit"><option value="minutes">Minutes Before</option><option value="hours">Hours Before</option><option value="days">Days Before</option></select></div>
                <div class="form-row"><label class="form-label">Repeat Daily</label><label class="toggle-switch"><input type="checkbox" id="dailyReuse"><span class="slider"></span></label></div>
                <div class="form-row"><label class="form-label">Enable Notifications</label><label class="toggle-switch"><input type="checkbox" id="browserNotifications" checked><span class="slider"></span></label></div>
            </div>
            <button class="btn" onclick="addTracker()">Create Tracker</button>
            <div id="trackersList" style="margin-top:24px;"></div>
        </div>
    </div>
    
    <div id="diaper-content" class="tab-content">
        <div class="container">
            <h2>Log a Diaper</h2>
            <div class="diaper-counters">
                <button class="diaper-btn" onclick="logDiaper('pee')"><div class="emoji">💧</div><div class="label">Pee</div></button>
                <button class="diaper-btn" onclick="showSeveritySelector()"><div class="emoji">💩</div><div class="label">Poop</div></button>
            </div>
            <div class="severity-selector" id="severitySelector">
                <p style="text-align:center; color:var(--text-secondary); margin-bottom:10px;">Select Severity (3 = worst)</p>
                <div class="severity-buttons">
                    <button class="btn" onclick="logDiaper('poop', 1)">1</button>
                    <button class="btn" onclick="logDiaper('poop', 2)">2</button>
                    <button class="btn" onclick="logDiaper('poop', 3)">3</button>
                </div>
            </div>
            <div class="log-list" id="diaperLog"></div>
        </div>
    </div>

    <div class="tab-bar">
        <button class="tab-button active" onclick="switchTab('homescreen')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>Home</button>
        <button class="tab-button" onclick="switchTab('feeding')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Z"/><path d="M12 12v5"/><path d="M12 7h.01"/></svg>Feeding</button>
        <button class="tab-button" onclick="switchTab('tracker')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>Tracker</button>
        <button class="tab-button" onclick="switchTab('diaper')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.59a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>Diapers</button>
    </div>

    <script>
        // --- DATA STATE ---
        let trackers = [], feedings = [], diapers = [];
        let selectedBreast = null;

        // --- STOPWATCH STATE ---
        let stopwatchInterval = null, stopwatchStartTime = 0, elapsedTime = 0;

        // --- CORE APP INITIALIZATION ---
        function init() {
            document.getElementById('trackerDate').valueAsDate = new Date();
            loadData();
            switchTab('homescreen');
            document.getElementById('startStopBtn').addEventListener('click', toggleStopwatch);
            document.getElementById('resetBtn').addEventListener('click', resetStopwatch);
            document.getElementById('logFeedBtn').addEventListener('click', logFeed);
            setInterval(checkTriggers, 5000);
            requestNotificationPermission();
        }

        // --- TAB SWITCHING LOGIC ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(`${tabName}-content`).classList.add('active');
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelector(`.tab-button[onclick="switchTab('${tabName}')"]`).classList.add('active');
            if (tabName === 'homescreen') renderHomescreen();
            if (tabName === 'tracker') renderTrackers();
            if (tabName === 'diaper') { renderDiaperSummary(); renderDiaperLog(); }
            if (tabName === 'feeding') renderFeedingLog();
        }

        // --- TAB 1: HOMESCREEN ---
        function renderHomescreen() {
            const todayStart = new Date().setHours(0, 0, 0, 0);
            const feedingsToday = feedings.filter(f => f.timestamp >= todayStart);
            const poopsToday = diapers.filter(d => d.timestamp >= todayStart && d.type === 'poop').length;
            const peesToday = diapers.filter(d => d.timestamp >= todayStart && d.type === 'pee').length;
            const lastBottle = feedings.slice().reverse().find(f => f.amount > 0);
            
            let trackerListHtml = trackers
                .sort((a,b) => new Date(a.date + 'T' + a.firstEventTime) - new Date(b.date + 'T' + b.firstEventTime))
                .map(tracker => {
                    return `<div class="tracker-summary-item">
                        <span>${tracker.name}</span>
                        <span style="color: var(--text-secondary);">${new Date(tracker.date + 'T00:00:00').toLocaleDateString([], {month:'short', day:'numeric'})}, ${tracker.firstEventTime}</span>
                    </div>`;
            }).join('');

            if (trackers.length === 0) {
                trackerListHtml = `<span style="color: var(--text-secondary);">No trackers scheduled.</span>`;
            }

            document.getElementById('summary-section').innerHTML = `
                <div class="summary-grid">
                    <div class="card"><div class="card-title">Feeds Today</div><div class="card-value">${feedingsToday.length}</div></div>
                    <div class="card"><div class="card-title">Diapers Today</div><div class="card-value">${poopsToday}💩 / ${peesToday}💧</div></div>
                </div>
                <div class="card"><div class="card-title">Last Bottle</div><div class="card-value">${lastBottle ? `${lastBottle.amount} ${lastBottle.unit}` : 'N/A'}</div></div>
                <div class="card" style="margin-top:16px;">
                    <div class="card-title">Trackers</div>
                    ${trackerListHtml}
                </div>`;
        }
        
        // --- TAB 2: FEEDING TRACKER ---
        function selectBreast(side) {
            if (selectedBreast === side) {
                selectedBreast = null;
                document.getElementById(`breast-${side}`).classList.remove('selected');
            } else {
                selectedBreast = side;
                document.querySelectorAll('.breast-toggle button').forEach(btn => btn.classList.remove('selected'));
                document.getElementById(`breast-${side}`).classList.add('selected');
            }
        }
        function toggleStopwatch() {
            const btn = document.getElementById('startStopBtn');
            if (stopwatchInterval) {
                clearInterval(stopwatchInterval); stopwatchInterval = null;
                elapsedTime += Date.now() - stopwatchStartTime;
                btn.textContent = 'Resume'; btn.classList.add('btn-secondary');
            } else {
                stopwatchStartTime = Date.now();
                stopwatchInterval = setInterval(updateStopwatchDisplay, 100);
                btn.textContent = 'Pause'; btn.classList.remove('btn-secondary');
            }
        }
        function resetStopwatch() {
            clearInterval(stopwatchInterval); stopwatchInterval = null; elapsedTime = 0;
            document.getElementById('startStopBtn').textContent = 'Start';
            document.getElementById('startStopBtn').classList.remove('btn-secondary');
            updateStopwatchDisplay();
            selectedBreast = null;
            document.querySelectorAll('.breast-toggle button').forEach(btn => btn.classList.remove('selected'));
        }
        function updateStopwatchDisplay() {
            let current = elapsedTime + (stopwatchInterval ? Date.now() - stopwatchStartTime : 0);
            const s = Math.floor(current / 1000);
            document.getElementById('stopwatchDisplay').textContent = `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
        }
        function logFeed() {
            const amount = document.getElementById('bottleAmount').value, unit = document.getElementById('bottleUnit').value, duration = document.getElementById('stopwatchDisplay').textContent;
            if (!amount && duration === "00:00:00") return alert("Please start the timer or enter a bottle amount.");
            feedings.push({ timestamp: Date.now(), duration, amount: amount || 0, unit, side: selectedBreast });
            saveData(); alert("Feed logged!");
            renderFeedingLog(); renderHomescreen(); resetStopwatch();
            document.getElementById('bottleAmount').value = '';
        }
        function renderFeedingLog() {
            const container = document.getElementById('feedingLog');
            container.innerHTML = '<h2>Recent Feedings</h2>' + feedings.slice().sort((a, b) => b.timestamp - a.timestamp).map(feed => {
                const dateTime = new Date(feed.timestamp).toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                let sideInfo = feed.side ? ` on ${feed.side}` : '';
                let durationInfo = feed.duration !== "00:00:00" ? `${feed.duration}${sideInfo}` : '';
                let bottleInfo = feed.amount > 0 ? `${feed.amount} ${feed.unit} bottle` : '';
                let details = [durationInfo, bottleInfo].filter(Boolean).join(' + ');
                return `<div class="log-item"><div class="log-details">${details || 'Logged Event'}</div><div class="log-time">${dateTime}</div></div>`;
            }).join('');
        }

        // --- TAB 3: SCHEDULE TRACKER ---
        function addTracker() {
            const tracker = {
                id: Date.now(), name: document.getElementById('trackerName').value || "Untitled Event",
                date: document.getElementById('trackerDate').value, firstEventTime: document.getElementById('firstEventTime').value,
                endTime: document.getElementById('endTime').value, intervalAmount: parseInt(document.getElementById('intervalAmount').value),
                intervalUnit: document.getElementById('intervalUnit').value, alertBefore: parseInt(document.getElementById('alertBefore').value),
                alertUnit: document.getElementById('alertUnit').value, dailyReuse: document.getElementById('dailyReuse').checked,
                enableNotifications: document.getElementById('browserNotifications').checked, active: true
            };
            if (!tracker.date || !tracker.firstEventTime || !tracker.endTime) return alert('Please fill in a date, start time, and end time.');
            tracker.reminders = generateReminders(tracker);
            trackers.push(tracker);
            saveAndRender(); clearTrackerForm();
        }
        function clearTrackerForm() { document.getElementById('trackerName').value = ''; document.getElementById('firstEventTime').value = ''; document.getElementById('endTime').value = ''; }
        function generateReminders(tracker) {
            const reminders = [], start = timeStringToMinutes(tracker.firstEventTime), end = timeStringToMinutes(tracker.endTime);
            if (start >= end) return [{ time: tracker.firstEventTime, triggered: false }];
            let interval = tracker.intervalUnit === 'hours' ? tracker.intervalAmount * 60 : tracker.intervalAmount;
            for (let t = start; t < end; t += interval) reminders.push({ time: minutesToTimeString(t), triggered: false });
            if (!reminders.find(r => r.time === tracker.endTime)) reminders.push({ time: tracker.endTime, triggered: false });
            return reminders;
        }
        function updateReminderTime(id, i, val) {
            const tracker = trackers.find(t => t.id === id);
            if (!tracker) return;

            const oldTimeInMinutes = timeStringToMinutes(tracker.reminders[i].time);
            const newTimeInMinutes = timeStringToMinutes(val);
            const timeDiff = newTimeInMinutes - oldTimeInMinutes;

            tracker.reminders[i].time = val; // Update the changed reminder first

            for (let j = i + 1; j < tracker.reminders.length; j++) {
                const currentReminderTime = timeStringToMinutes(tracker.reminders[j].time);
                tracker.reminders[j].time = minutesToTimeString(currentReminderTime + timeDiff);
            }
            saveAndRender();
        }
        function renderTrackers() {
            const c = document.getElementById('trackersList');
            if (trackers.length === 0) return c.innerHTML = `<div class="empty-state">No trackers created yet.</div>`;
            c.innerHTML = trackers.map(t => `
                <div class="tracker-item"><h4>${t.name}</h4><div class="tracker-date">${formatDate(t.date)}</div>
                <div class="reminder-list">${t.reminders.map((r, i) => `<input type="time" class="reminder-time-input" value="${r.time}" onchange="updateReminderTime(${t.id},${i},this.value)">`).join('')}</div>
                <div class="action-buttons"><div class="notify-toggle-group"><label class="toggle-switch"><input type="checkbox" onchange="toggleNotification(${t.id})"${t.enableNotifications?'checked':''}> <span class="slider"></span></label><span>Notify</span></div>
                <button class="btn-small" onclick="exportToCalendar(${t.id})">Calendar</button><button class="btn-small btn-danger" onclick="deleteTracker(${t.id})">Delete</button></div></div>`).join('');
        }
        function toggleNotification(id) { const t=trackers.find(tr=>tr.id===id); if(t){t.enableNotifications=!t.enableNotifications; saveData();} }
        function deleteTracker(id) { trackers=trackers.filter(t=>t.id!==id); saveAndRender(); }
        
        // --- TAB 4: DIAPER COUNTER ---
        function showSeveritySelector() { document.getElementById('severitySelector').style.display = 'block'; }
        function logDiaper(type, severity=null) {
            const diaper = { timestamp: Date.now(), type };
            if (severity) { diaper.severity = severity; document.getElementById('severitySelector').style.display = 'none'; }
            diapers.push(diaper); saveData();
            renderDiaperLog(); renderDiaperSummary(); renderHomescreen();
        }
        function renderDiaperLog() {
            const c = document.getElementById('diaperLog');
            c.innerHTML = '<h2>Recent Diapers</h2>' + diapers.slice().sort((a,b)=>b.timestamp-a.timestamp).map(d => {
                const dateTime = new Date(d.timestamp).toLocaleString([], {month: 'short', day: 'numeric', hour:'2-digit',minute:'2-digit'});
                let details = d.type==='pee' ? 'Pee 💧' : `Poop 💩 (Severity: ${d.severity || 'N/A'})`;
                return `<div class="log-item"><div class="log-details">${details}</div><div class="log-time">${dateTime}</div></div>`;
            }).join('');
        }
        function renderDiaperSummary() {
            const todayStart = new Date().setHours(0,0,0,0);
            const poops=diapers.filter(d=>d.timestamp>=todayStart&&d.type==='poop').length;
            const pees=diapers.filter(d=>d.timestamp>=todayStart&&d.type==='pee').length;
            document.getElementById('diaper-summary-section').innerHTML=`<div class="card"><div class="card-title">Today's Summary</div><div class="card-value">${poops} 💩 / ${pees} 💧</div></div>`;
        }

        // --- UTILITY, DATA & NOTIFICATION FUNCTIONS ---
        function formatDate(dStr) { return new Date(dStr+'T00:00:00').toLocaleDateString(undefined,{weekday:'long',year:'numeric',month:'long',day:'numeric'}); }
        function timeStringToMinutes(tStr) { const [h,m]=tStr.split(':').map(Number); return h*60+m; }
        function minutesToTimeString(m) { return `${String(Math.floor(m/60)%24).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`; }
        function exportToCalendar(id) { const t=trackers.find(tr=>tr.id===id); if(t) downloadFile(`${t.name}.ics`,generateICSFile(t)); }
        function generateICSFile(t) {
            const dateStr = t.date.replace(/-/g, '');
            let content=`BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//BottleBuddy//EN\n`;
            let alertDesc = '';
            if (t.alertBefore > 0) {
                alertDesc = `\\nAlert: ${t.alertBefore} ${t.alertUnit} before`;
                const unit = t.alertUnit.charAt(0).toUpperCase();
                content += `BEGIN:VALARM\nACTION:DISPLAY\nDESCRIPTION:Reminder for ${t.name}\nTRIGGER:-PT${t.alertBefore}${unit}\nEND:VALARM\n`;
            }
            
            t.reminders.forEach((r,i) => {
                const startTimeRaw = `${t.date}T${r.time}`;
                const startTime = startTimeRaw.replace(/[-:]/g, '');
                content+=`BEGIN:VEVENT\nUID:${t.id}-${i}@bottlebuddy.app\nDTSTAMP:${startTime}\nDTSTART:${startTime}\nSUMMARY:${t.name}\nDESCRIPTION:Scheduled feeding reminder.${alertDesc}\n${t.dailyReuse?'RRULE:FREQ=DAILY\n':''}END:VEVENT\n`;
            });
            return content+'END:VCALENDAR';
        }
        function downloadFile(fname,text) { const a=document.createElement('a'); a.href='data:text/calendar;charset=utf-8,'+encodeURIComponent(text); a.download=fname; a.click(); }
        function saveData() { localStorage.setItem('bottleBuddyData', JSON.stringify({trackers,feedings,diapers})); }
        function loadData() { const d=localStorage.getItem('bottleBuddyData'); if(d){const p=JSON.parse(d); trackers=p.trackers||[]; feedings=p.feedings||[]; diapers=p.diapers||[];} }
        function saveAndRender() { saveData(); renderTrackers(); }
        function checkTriggers() {
            const now=new Date(), time=now.toTimeString().slice(0,5), date=now.toISOString().slice(0,10);
            trackers.forEach(t=>{ if(t.date===date&&t.enableNotifications) t.reminders.forEach(r=>{ if(r.time===time&&!r.triggered){ triggerReminder(t,r); r.triggered=true; saveData(); } }); });
        }
        function triggerReminder(t,r) { if(Notification.permission==='granted') new Notification(t.name,{body:`It's time for your ${r.time} reminder.`,icon:'icon.png'}); }
        function requestNotificationPermission() { if('Notification' in window&&Notification.permission==='default') Notification.requestPermission(); }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
